# Crates Proxy - RuståŒ…ç¼“å­˜ä»£ç†æœåŠ¡å™¨

ä¸€ä¸ªé«˜æ€§èƒ½çš„Rust crates.ioç¼“å­˜ä»£ç†æœåŠ¡å™¨ï¼Œä¸“é—¨è®¾è®¡ç”¨äºåŠ é€Ÿcargoç¼–è¯‘è¿‡ç¨‹ä¸­çš„ä¾èµ–åŒ…ä¸‹è½½ã€‚

## ğŸš€ ç‰¹æ€§

- **ğŸ“¦ æ™ºèƒ½ç¼“å­˜**: è‡ªåŠ¨ç¼“å­˜æ‰€æœ‰ç‰ˆæœ¬çš„RuståŒ…ï¼Œæ”¯æŒå¤æ‚çš„ä¾èµ–å…³ç³»
- **âš¡ é«˜æ€§èƒ½**: åŸºäºHyper HTTPæœåŠ¡å™¨å’ŒMelangeDBåµŒå…¥å¼æ•°æ®åº“
- **ğŸ”„ ç‰ˆæœ¬ç®¡ç†**: å®Œæ•´çš„ç‰ˆæœ¬ä¿¡æ¯ç®¡ç†ï¼Œæ”¯æŒTTLè¿‡æœŸæœºåˆ¶
- **ğŸŒ ä»£ç†æ”¯æŒ**: æ”¯æŒHTTP/SOCKS5ä»£ç†é…ç½®
- **ğŸ“Š ç»Ÿè®¡ç›‘æ§**: æä¾›è¯¦ç»†çš„ç¼“å­˜ç»Ÿè®¡å’Œæ¸…ç†åŠŸèƒ½
- **ğŸ›¡ï¸ ç”Ÿäº§å°±ç»ª**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

## ğŸ¯ é€‚ç”¨åœºæ™¯

- ä¼ä¸šå†…ç½‘ç¯å¢ƒä¸‹çš„cargoåŒ…åŠ é€Ÿ
- CI/CDæµæ°´çº¿ä¸­çš„ä¾èµ–ç¼“å­˜
- ç¦»çº¿å¼€å‘ç¯å¢ƒçš„åŒ…ç®¡ç†
- å¤šå›¢é˜Ÿå…±äº«çš„åŒ…ç¼“å­˜æœåŠ¡

## ğŸ“‹ ç³»ç»Ÿè¦æ±‚

- Rust 1.70+
- å¯ç”¨ç£ç›˜ç©ºé—´ï¼ˆç”¨äºç¼“å­˜ï¼‰
- ç½‘ç»œè¿æ¥ï¼ˆç”¨äºé¦–æ¬¡ä¸‹è½½ï¼‰

## ğŸ› ï¸ å®‰è£…

### ä»æºç æ„å»º

```bash
git clone https://github.com/your-username/crates_proxy.git
cd crates_proxy
cargo build --release
```

### ä½¿ç”¨cargoå®‰è£…

```bash
cargo install crates_proxy
```

## âš™ï¸ é…ç½®

æœåŠ¡å™¨ä½¿ç”¨ `config.toml` æ–‡ä»¶è¿›è¡Œé…ç½®ã€‚é¦–æ¬¡è¿è¡Œæ—¶ä¼šè‡ªåŠ¨åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶ï¼š

```toml
[server]
bind_addr = "127.0.0.1:8080"

[cache]
storage_path = "./cache"
default_ttl = 3600

[logging]
level = "info"

[user_agent]
value = "Mozilla/5.0 ( compatible crates-proxy/0.1.0 )"

# å¯é€‰ï¼šä»£ç†é…ç½®
# [upstream]
# proxy_url = "http://proxy.example.com:8080"
```

## ğŸš€ è¿è¡Œ

### åŸºæœ¬è¿è¡Œ

```bash
cargo run
```

### æŒ‡å®šé…ç½®æ–‡ä»¶

```bash
cargo run -- -f /path/to/config.toml
```

### åå°è¿è¡Œ

```bash
nohup cargo run > server.log 2>&1 &
```

## ğŸ“– ä½¿ç”¨æ–¹æ³•

### é…ç½®cargoä½¿ç”¨ä»£ç†

åœ¨ä½ çš„é¡¹ç›® `.cargo/config.toml` ä¸­æ·»åŠ ï¼š

```toml
[source.crates-io]
replace-with = 'local-registry'

[source.local-registry]
registry = "https://your-proxy-server:8080/index"
```

æˆ–è€…åœ¨ç¯å¢ƒå˜é‡ä¸­è®¾ç½®ï¼š

```bash
export CARGO_HTTP_PROXY=http://127.0.0.1:8080
```

### ç›´æ¥ä¸‹è½½åŒ…

```bash
# ä¸‹è½½æœ€æ–°ç‰ˆæœ¬
curl http://127.0.0.1:8080/api/v1/crates/tokio/latest/download -o tokio.crate

# ä¸‹è½½æŒ‡å®šç‰ˆæœ¬
curl http://127.0.0.1:8080/api/v1/crates/tokio/1.0.0/download -o tokio-1.0.0.crate
```

## ğŸ”§ å‘½ä»¤è¡Œé€‰é¡¹

```bash
crates-proxy [OPTIONS]

é€‰é¡¹:
  -f, --config <FILE>     é…ç½®æ–‡ä»¶è·¯å¾„
  -c, --clean             æ¸…ç†è¿‡æœŸç¼“å­˜
  -s, --stats             æ˜¾ç¤ºç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
  -h, --help              æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
  -V, --version           æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
```

### ç¤ºä¾‹

```bash
# æ¸…ç†è¿‡æœŸç¼“å­˜
cargo run -- --clean

# æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡
cargo run -- --stats

# ä½¿ç”¨è‡ªå®šä¹‰é…ç½®
cargo run -- -f /path/to/custom_config.toml
```

## ğŸ“Š ç¼“å­˜ç®¡ç†

### æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯

```bash
cargo run -- --stats
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯:
  æ€»æ–‡ä»¶æ•°: 87
  æœ‰æ•ˆæ–‡ä»¶æ•°: 87
  è¿‡æœŸæ–‡ä»¶æ•°: 0
  æ€»å¤§å°: 605481 å­—èŠ‚
```

### æ¸…ç†è¿‡æœŸç¼“å­˜

```bash
cargo run -- --clean
```

è¿™å°†æ¸…ç†ï¼š
- è¿‡æœŸçš„æ–‡ä»¶ç¼“å­˜
- è¿‡æœŸçš„ç‰ˆæœ¬ç®¡ç†æ•°æ®
- ç©ºçš„ç›®å½•ç»“æ„

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶

1. **ProxyService**: ä¸»è¦çš„HTTPæœåŠ¡ç»„ä»¶
2. **CratesApiClient**: crates.io APIå®¢æˆ·ç«¯
3. **CacheManager**: æ–‡ä»¶ç¼“å­˜ç®¡ç†å™¨
4. **VersionManager**: ç‰ˆæœ¬ä¿¡æ¯ç®¡ç†å™¨ï¼ˆåŸºäºMelangeDBï¼‰
5. **CurlClient**: HTTPä¸‹è½½å®¢æˆ·ç«¯

### ç¼“å­˜ç­–ç•¥

- **æ–‡ä»¶ç¼“å­˜**: ä¸‹è½½çš„crateæ–‡ä»¶å­˜å‚¨åœ¨æ–‡ä»¶ç³»ç»Ÿ
- **ç‰ˆæœ¬ç¼“å­˜**: ç‰ˆæœ¬ä¿¡æ¯å­˜å‚¨åœ¨MelangeDBä¸­
- **å†…å­˜ç¼“å­˜**: çƒ­ç‚¹æ•°æ®åœ¨å†…å­˜ä¸­ç¼“å­˜
- **TTLæœºåˆ¶**: è‡ªåŠ¨è¿‡æœŸæ¸…ç†

### å·¥ä½œæµç¨‹

1. æ¥æ”¶cargoä¸‹è½½è¯·æ±‚
2. è§£æåŒ…åå’Œç‰ˆæœ¬ä¿¡æ¯
3. æ£€æŸ¥ç‰ˆæœ¬ç®¡ç†å™¨è·å–ç‰ˆæœ¬ä¿¡æ¯
4. æ£€æŸ¥æ–‡ä»¶ç¼“å­˜æ˜¯å¦å­˜åœ¨
5. ç¼“å­˜å‘½ä¸­åˆ™ç›´æ¥è¿”å›
6. ç¼“å­˜æœªå‘½ä¸­åˆ™ä»crates.ioä¸‹è½½
7. ä¿å­˜åˆ°ç¼“å­˜å¹¶è¿”å›ç»™å®¢æˆ·ç«¯

## ğŸ§ª å¼€å‘

### è¿è¡Œæµ‹è¯•

```bash
cargo test
```

### è¿è¡Œç¤ºä¾‹

```bash
cargo run --example simple_curl_test
```

### ä»£ç ç»“æ„

```
src/
â”œâ”€â”€ main.rs              # åº”ç”¨å…¥å£
â”œâ”€â”€ proxy.rs             # ä»£ç†æœåŠ¡æ ¸å¿ƒ
â”œâ”€â”€ crates_api.rs        # crates.io APIå®¢æˆ·ç«¯
â”œâ”€â”€ cache.rs             # æ–‡ä»¶ç¼“å­˜ç®¡ç†
â”œâ”€â”€ version_manager.rs   # ç‰ˆæœ¬ä¿¡æ¯ç®¡ç†
â”œâ”€â”€ curl_client.rs       # HTTPä¸‹è½½å®¢æˆ·ç«¯
â””â”€â”€ config.rs            # é…ç½®ç®¡ç†
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

- **MelangeDB**: é«˜æ€§èƒ½åµŒå…¥å¼æ•°æ®åº“ï¼Œæ”¯æŒå‹ç¼©å’Œç¼“å­˜
- **æ‰¹é‡å¤„ç†**: ä¸€æ¬¡è·å–æ‰€æœ‰ç‰ˆæœ¬ä¿¡æ¯
- **æ™ºèƒ½ç¼“å­˜**: å¤šçº§ç¼“å­˜ç­–ç•¥
- **å¼‚æ­¥å¤„ç†**: åŸºäºTokioçš„å¼‚æ­¥æ¶æ„
- **å®šæœŸæ¸…ç†**: è‡ªåŠ¨è¿‡æœŸæ•°æ®æ¸…ç†

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestï¼

### å¼€å‘æµç¨‹

1. Forké¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. åˆ›å»ºPull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨LGPLv3è®¸å¯è¯ã€‚è¯¦è§[LICENSE](LICENSE)æ–‡ä»¶ã€‚

## ğŸ”— ç›¸å…³é“¾æ¥

- [crates.io](https://crates.io/)
- [Cargo Book](https://doc.rust-lang.org/cargo/)
- [MelangeDB](https://crates.io/crates/melange_db)
- [Hyper](https://hyper.rs/)

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æäº¤Issueæˆ–è”ç³»ç»´æŠ¤è€…ã€‚

---

**æ³¨æ„**: æœ¬é¡¹ç›®ä»…ç”¨äºåˆæ³•çš„ç¼“å­˜åŠ é€Ÿç”¨é€”ï¼Œè¯·éµå®ˆcrates.ioçš„ä½¿ç”¨æ¡æ¬¾å’ŒæœåŠ¡åè®®ã€‚